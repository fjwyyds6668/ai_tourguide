# 数字人角色配置说明

## 一、数据库中的角色配置（Character 模型）

数字人角色配置存储在 PostgreSQL 数据库的 `characters` 表中，包含以下字段：

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| **id** | Int | ✅ | 角色ID（自增） | `1` |
| **name** | String | ✅ | 角色名称 | `"亲切导游"`、`"专业学者"`、`"女大学生"` |
| **description** | String | ❌ | 角色简介 | `"一位热情友好的导游..."` |
| **avatarUrl** | String | ❌ | 头像URL（暂未使用） | `null` |
| **style** | String | ❌ | 角色风格 | `"friendly"`、`"scholar"`、`"young"` |
| **prompt** | String | ❌ | 角色提示词 | `"你是一位亲切友好的景区导游..."` |
| **voice** | String | ❌ | TTS 语音名称 | `"zh-CN-XiaoxiaoNeural"` |
| **isActive** | Boolean | ✅ | 是否激活 | `true` |
| **createdAt** | DateTime | ✅ | 创建时间 | `2024-01-01 00:00:00` |
| **updatedAt** | DateTime | ❌ | 更新时间 | `2024-01-01 00:00:00` |

### 配置说明

1. **name（角色名称）**：显示在前端角色选择界面
2. **description（角色简介）**：用于展示角色特点
3. **style（角色风格）**：用于分类和筛选角色
4. **prompt（角色提示词）**：控制 AI 回答的风格、语气和身份设定，会合并到系统提示词中
5. **voice（TTS 语音）**：Edge TTS 语音名称，可选值：
   - `zh-CN-XiaoxiaoNeural`（默认，温柔女声）
   - `zh-CN-XiaoyiNeural`（年轻女声）
   - `zh-CN-YunjianNeural`（成熟男声）
   - `zh-CN-YunxiNeural`（年轻男声）
   - `zh-CN-YunxiaNeural`（儿童男声）
   - `zh-CN-YunyangNeural`（成熟男声）
   - `zh-CN-XiaohanNeural`（温柔女声）
   - `zh-CN-XiaomoNeural`（温柔女声）

## 二、Live2D 模型配置

Live2D 模型配置存储在 `/frontend-tourist/public/sentio/characters/free/<角色名>/<角色名>.model3.json` 文件中。

### 可用的 Live2D 角色

当前可用的 Live2D 角色（位于 `free` 组）：

1. **Mao**（默认）- 艺术家风格，有丰富的动作和表情
2. **Chitose** - 温柔风格，有指引动作
3. **Tsumiki** - 可爱风格
4. **Hibiki** - 活泼风格
5. **Izumi** - 成熟风格
6. **Hiyori** - 标准风格
7. **Haru** - 友好风格
8. **Epsilon** - 优雅风格
9. **Shizuku** - 文静风格
10. **Kei** - 专业风格（支持多语言）

### Live2D 模型配置结构

```json
{
  "Version": 3,
  "FileReferences": {
    "Moc": "Mao.moc3",                    // 模型文件
    "Textures": [...],                    // 纹理文件
    "Physics": "Mao.physics3.json",      // 物理效果
    "Pose": "Mao.pose3.json",            // 姿势
    "Expressions": [                      // 表情列表
      { "Name": "happy", "File": "expressions/开心.exp3.json" },
      { "Name": "smile", "File": "expressions/微笑.exp3.json" },
      ...
    ],
    "Motions": {                          // 动作列表
      "Idle": [...],                      // 待机动作
      "TapBody": [...]                    // 点击身体动作
    }
  },
  "Groups": [
    {
      "Target": "Parameter",
      "Name": "LipSync",                  // 嘴巴同步参数
      "Ids": ["ParamMouthOpenY"]
    }
  ]
}
```

### 表情（Expressions）

每个角色支持的表情（名称可能不同）：

- `happy` / `开心` - 开心表情
- `smile` / `微笑` - 微笑表情
- `sad` / `伤心` - 伤心表情
- `angry` / `生气` - 生气表情
- `surprised` / `惊讶` - 惊讶表情
- `blushing` / `脸红` - 脸红表情
- `embarrass` / `尴尬` - 尴尬表情

### 动作（Motions）

每个角色支持的动作组：

- **Idle** - 待机动作（自动循环）
- **TapBody** - 点击身体触发的动作（随机选择）

## 三、角色配置与 Live2D 模型的关联

**当前状态**：数据库中的角色配置与 Live2D 模型是**分离的**。

- 数据库角色配置：控制 AI 回答风格和 TTS 语音
- Live2D 模型：控制数字人的外观、动作和表情

**建议的关联方式**：

1. 在数据库 `characters` 表中添加字段：
   - `live2d_character_name`：Live2D 角色名称（如 "Mao"、"Chitose"）
   - `live2d_character_group`：Live2D 角色组（默认 "free"）

2. 前端根据数据库配置加载对应的 Live2D 模型

## 四、当前功能状态

### ✅ 已实现

- [x] 数据库角色配置管理（CRUD）
- [x] 角色提示词控制 AI 回答风格
- [x] TTS 语音配置
- [x] Live2D 模型加载和显示
- [x] 基础动画（眨眼、呼吸、物理效果）

### ❌ 未实现（需要开发）

- [ ] **嘴巴同步（Lip-Sync）**：根据音频播放实时控制嘴巴开合
- [ ] **动作控制**：根据对话内容触发相应动作
- [ ] **表情控制**：根据对话情感触发相应表情
- [ ] **数据库角色与 Live2D 模型关联**：根据角色配置自动加载对应的 Live2D 模型

## 五、如何配置新角色

### 1. 在数据库中创建角色

通过管理后台或 API 创建新角色：

```bash
POST /api/v1/characters/characters
{
  "name": "新角色名称",
  "description": "角色描述",
  "style": "friendly",
  "prompt": "角色提示词...",
  "voice": "zh-CN-XiaoxiaoNeural",
  "is_active": true
}
```

### 2. 添加 Live2D 模型（可选）

如果需要使用新的 Live2D 模型：

1. 将模型文件放入 `/frontend-tourist/public/sentio/characters/free/<角色名>/`
2. 修改前端代码，在角色选择时加载对应的模型

### 3. 关联配置（待实现）

在角色配置中添加 `live2d_character_name` 字段，前端根据此配置自动加载模型。

## 六、常见问题

### Q: 为什么数字人没有动作？

A: 当前只实现了基础动画（眨眼、呼吸），动作控制功能尚未实现。需要：
1. 在播放 TTS 时触发说话动作
2. 根据对话内容触发相应动作（如挥手、指引等）

### Q: 为什么嘴巴不会动？

A: 嘴巴同步功能尚未完全实现。虽然 Live2D 模型支持嘴巴同步（LipSync），但前端在播放音频时没有将音频数据传递给 Live2D 系统进行分析。

### Q: 如何让数字人根据对话内容做动作？

A: 需要实现动作控制逻辑：
1. 分析对话内容的情感/意图
2. 根据情感选择对应的动作和表情
3. 调用 Live2D API 播放动作

### Q: 如何切换不同的 Live2D 角色？

A: 当前前端硬编码使用 "Mao" 角色。需要：
1. 在数据库中添加 `live2d_character_name` 字段
2. 前端根据角色配置动态加载对应的 Live2D 模型

